function createLetterHeader(e){var t=Ti.UI.createTableViewRow({width:320,height:23,selectionStyle:Ti.UI.iPhone.TableViewCellSelectionStyle.NONE,backgroundImage:root+"/images/contacts/lettergreen-background.png"}),i=Ti.UI.createLabel({left:28,height:20,font:{fontSize:12},color:"#FFFFFF",text:e,top:0});return t.add(i),t}function createCallView(e){var t=Ti.UI.createView({width:160,height:30,left:0,backgroundColor:"#27A805",bottom:0}),i=Ti.UI.createLabel({width:"100%",height:"100%",text:"Call Now",textAlign:"center",font:{fontSize:10,fontWeight:"bold"},color:"#FFFFFF"});t.add(i);var a=Ti.UI.createImageView({image:root+"/images/contacts/phone2-icon.png",width:13,height:15,left:10});return t.add(a),t.number=e,t.addEventListener("click",function(){var e=this.number.replace(/[^0-9]/g,"");e=e.split(" ").join(""),Ti.Platform.openURL("tel:"+e)}),t}function createSmsView(e){var t=Ti.UI.createView({width:159.5,height:30,right:0,backgroundColor:"#0575E3",bottom:0}),i=Ti.UI.createLabel({width:"100%",height:"100%",text:"  Send a Text Message",textAlign:"center",font:{fontSize:10,fontWeight:"bold"},color:"#FFFFFF"});t.add(i);var a=Ti.UI.createImageView({image:root+"/images/contacts/textmessage-icone.png",width:15,height:15,left:10});return t.add(a),t.number=e,t.addEventListener("click",function(){var e=this.number.replace(/[^0-9]/g,"");e=e.split(" ").join(""),Ti.Platform.openURL("sms:"+e)}),t}function createContactLine(e,t,i){var a=Ti.UI.createTableViewRow({width:320,height:80,backgroundColor:"#FFFFFF",selectionStyle:Ti.UI.iPhone.TableViewCellSelectionStyle.NONE});a.number=i;var n=createCallView(i),o=createSmsView(i),r=Ti.UI.createView({height:40,width:.5,left:160,backgroundColor:"#FFFFFF"});a.add(n),a.add(o),a.add(r);var c=Ti.UI.createTextField({width:120,left:160,font:{fontSize:13},value:i,top:0,height:50,enabled:!1,keyboardType:Ti.UI.KEYBOARD_NUMBER_PAD});a.add(c);var s=Ti.UI.createTextField({width:120,left:30,font:{fontSize:13},value:t,top:0,height:50,enabled:!1,numField:c});a.add(s);var d=Ti.UI.createImageView({width:12,height:12,image:root+"/images/contacts/user-icon.png",left:10,top:19});a.add(d);var l=Ti.UI.createImageView({width:11,height:11,image:root+"/images/contacts/phone-icon.png",left:140,top:19.5});a.add(l);var g=Ti.UI.createImageView({width:8,height:13,image:root+"/images/contacts/arrow-trasnparent.png",right:10,top:18.5});a.add(g);var m=Ti.UI.createLabel({right:25,font:{fontSize:13},text:"Edit",top:0,height:50,color:"#666",id:e,nameField:s,numField:c});a.add(m),m.addEventListener("click",function(){this.nameField.enabled=!0,this.numField.enabled=!0,this.nameField.focus()}),s.addEventListener("return",function(){this.enabled=!1,this.numField.enabled=!1});var u=Ti.UI.createButton({backgroundImage:root+"/images/contacts/save-button.png",width:129,height:40,bottom:5,nameField:s,numField:c,id:e}),p=Ti.UI.createButton({systemButton:Ti.UI.iPhone.SystemButton.FLEXIBLE_SPACE}),h=Ti.UI.createButton({backgroundColor:"#27A805",title:"CANCEL",backgroundImage:"transparent",width:70,height:40,borderRadius:4,nameField:s,numField:c,font:{fontSize:13,fontWeight:"bold"}});u.addEventListener("click",function(){this.nameField.enabled=!1,this.numField.enabled=!1,this.nameField.blur(),this.numField.blur(),editContact(this.id,this.nameField.value,this.numField.value),newContactsArray=getContactsArray(),contactsTable.setData(getContactTableData(newContactsArray),{animationStyle:Ti.UI.iPhone.RowAnimationStyle.BOTTOM})}),h.addEventListener("click",function(){this.nameField.enabled=!1,this.numField.enabled=!1,this.nameField.blur(),this.numField.blur(),newContactsArray=getContactsArray(),contactsTable.data=getContactTableData(newContactsArray)});var b=Ti.UI.iOS.createToolbar({width:320,height:53,backgroundImage:root+"/images/contacts/button-background.png",items:[h,p,u],barColor:"#FFFFFF"}),w=Ti.UI.createView({width:320,height:4,backgroundImage:root+"/images/tabbar/color-lines.png",top:0});b.add(w),s.keyboardToolbar=b,c.keyboardToolbar=b;var T=Ti.UI.createImageView({width:1,height:34,image:root+"/images/contacts/separator.png",left:130,top:8});return a.add(T),a}function createTableSeperator(){var e=Ti.UI.createTableViewRow({width:320,height:5,selectionStyle:Ti.UI.iPhone.TableViewCellSelectionStyle.NONE,backgroundColor:"transparent"});return e}function editContact(e,t,i){var a='<?xml version="1.0" encoding="UTF-8"?><contacts>';contactsArrayOrdered=getContactsArray();for(var n in contactsArrayOrdered){var o=contactsArrayOrdered[n];a+="<contact>",a+="<id>"+o.id+"</id>",e==o.id?(a+="<name>"+t+"</name>",a+="<number>"+i+"</number>"):(a+="<name>"+o.name+"</name>",a+="<number>"+o.number+"</number>"),a+="</contact>"}a+="</contacts>";var r=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,"/contacts.xml");createFileIfNotExist(r),r.write(a)}function saveContact(e,t){var i='<?xml version="1.0" encoding="UTF-8"?><contacts>';contactsArrayOrdered=getContactsArray();for(var a in contactsArrayOrdered){var n=contactsArrayOrdered[a];i+="<contact>",i+="<id>"+n.id+"</id>",i+="<name>"+n.name+"</name>",i+="<number>"+n.number+"</number>",i+="</contact>"}i+="<contact>",i+="<id>"+(contactsArrayOrdered.length+1)+"</id>",i+="<name>"+e+"</name>",i+="<number>"+t+"</number>",i+="</contact>",i+="</contacts>";var o=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,"/contacts.xml");createFileIfNotExist(o),o.write(i),enterNumber.blur(),enterNumber.value="",enterName.blur(),enterName.value=""}function getContactsArray(){var e=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,"/contacts.xml");createFileIfNotExist(e);for(var t=e.read().text,i=Ti.XML.parseString(t),a=i.getElementsByTagName("contact"),n=[],o=[],r=0;a.length>r;r++){var c=a.item(r);n[r]={id:c.getElementsByTagName("id").item(0).text,name:c.getElementsByTagName("name").item(0).text,number:c.getElementsByTagName("number").item(0).text},o[r]=c.getElementsByTagName("name").item(0).text}var s;if("function"==typeof Object.keys)s=Object.keys(o);else for(var d in o)s.push(d);s.sort(function(e,t){return o[e].localeCompare(o[t])});var l=[];for(var g in s)l[g]=n[s[g]];return l}function getContactTableData(e){var t="A",i=[],a=0,n=0;for(var o in e){var r=e[o].id,c=e[o].name,s=e[o].number,d=createTableSeperator();if(c.substring(0,1).toUpperCase()!=t||0==n){i[a++]=d;var l=createLetterHeader(c.substring(0,1).toUpperCase());t=c.substring(0,1).toUpperCase(),i[a++]=l}var g=createContactLine(r,c,s);i[a++]=g,i[a++]=d,n++}return i}Ti.include("../functions.js");var win=Ti.UI.currentWindow;designWindow(win,"My Crisis Contacts",Ti.App.userbg,!0),createTabGroup(win,0);var contactsArrayOrdered=getContactsArray(),data=getContactTableData(contactsArrayOrdered),newContactView=Ti.UI.createView({height:50,width:320,backgroundImage:root+"/images/contacts/top-background.png",top:52});win.add(newContactView);var newBottomLine=Ti.UI.createView({width:320,height:4,backgroundImage:root+"/images/tabbar/colorlines.png",top:102});win.add(newBottomLine);var enterName=Ti.UI.createTextField({width:147,height:30,hintText:"Enter Name",left:10,backgroundImage:root+"/images/contacts/entername.png",paddingRight:5,paddingLeft:5,font:{fontSize:12}});newContactView.add(enterName);var enterNumber=Ti.UI.createTextField({width:147,height:30,hintText:"Enter Phone Number",right:10,backgroundImage:root+"/images/contacts/entername.png",paddingRight:5,paddingLeft:5,font:{fontSize:12},keyboardType:Ti.UI.KEYBOARD_NUMBER_PAD});newContactView.add(enterNumber);var contactsTable=Ti.UI.createTableView({width:320,height:"auto",separatorStyle:Ti.UI.iPhone.TableViewSeparatorStyle.NONE,separatorColor:"transparent",backgroundColor:"transparent",data:data,bottom:50,top:106,showVerticalScrollIndicator:!1});win.add(contactsTable),contactsTable.addEventListener("click",function(){enterNumber.blur()});var addwrapper=Ti.UI.createView({height:52,width:55,right:0,zIndex:999999,top:0});win.add(addwrapper);var addButton=Ti.UI.createButton({backgroundImage:root+"/images/contacts/add-plus-icon.png",width:13,height:13,right:10});addwrapper.add(addButton);var addLabel=Ti.UI.createLabel({color:"#27A805",font:{fontSize:16},text:"Add",left:0});addwrapper.add(addLabel);var addButton=Ti.UI.createButton({backgroundImage:root+"/images/contacts/add-button.png",width:130,height:40,bottom:5}),flexSpace=Ti.UI.createButton({systemButton:Ti.UI.iPhone.SystemButton.FLEXIBLE_SPACE}),keyboardBar=Ti.UI.iOS.createToolbar({width:320,height:53,backgroundImage:root+"/images/contacts/button-background.png",items:[flexSpace,addButton,flexSpace],barColor:"#FFFFFF"}),barLine=Ti.UI.createView({width:320,height:4,backgroundImage:root+"/images/tabbar/color-lines.png",top:0});keyboardBar.add(barLine),enterName.keyboardToolbar=keyboardBar,enterNumber.keyboardToolbar=keyboardBar,addwrapper.addEventListener("click",function(){enterName.focus()}),addButton.addEventListener("click",function(){""!=enterName.value&&""!=enterNumber.value?(saveContact(enterName.value,enterNumber.value),newContactsArray=getContactsArray(),contactsTable.setData(getContactTableData(newContactsArray),{animationStyle:Ti.UI.iPhone.RowAnimationStyle.BOTTOM})):getAlert("All fields are required!")}),enterName.addEventListener("focus",function(){enterName.backgroundImage=root+"/images/contacts/enterphone-active.png"}),enterName.addEventListener("blur",function(){enterName.backgroundImage=root+"/images/contacts/entername.png"}),enterNumber.addEventListener("focus",function(){enterNumber.backgroundImage=root+"/images/contacts/enterphone-active.png"}),enterNumber.addEventListener("blur",function(){enterNumber.backgroundImage=root+"/images/contacts/entername.png"});